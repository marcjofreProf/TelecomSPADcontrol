#!/bin/bash

# Script to initiate the DC bias low speed ramp, and Gating if needed.

# To run the script
# debian@beaglebone:~/Scripts/TelecomSPADcontrol$ ./upSPADspi0controlBBBon.sh

# Execute on a BeagleBone Black with no overlays loaded.
# These commands require the default pin configuration in order to work.
# Ask user wether to activate Gating or not
read -p "Turn ON Gating [y/n]?: " answerGating
# Convert answer to lowercase for case-insensitive comparison
answerGating=${answerGating,,}

# First, disable Gating just in case it was on
cd /sys/class/pwm/pwmchip7/pwm-7\:0
sudo config-pin P8_19 pwm
# Always at least set a period and duty cycle so that the pwm can be disabled
sudo sh -c "echo '50' >> ./period"
sudo sh -c "echo '5' >> ./duty_cycle"
sudo sh -c "echo '0' >> ./enable"
# Re-confirm order
sudo sh -c "echo '0' >> ./enable"

# turn-off optocoupled relay
cd /sys/class/pwm/pwmchip4/pwm-4\:0
sudo config-pin P9_14 pwm
# Always at least set a period and duty cycle so that the pwm can be disabled
sudo sh -c "echo '50' >> ./period"
sudo sh -c "echo '5' >> ./duty_cycle"
sudo sh -c "echo '0' >> ./enable"
# Re-confirm order
sudo sh -c "echo '0' >> ./enable"


# DC bias control 
cd /home/debian/Scripts/TelecomSPADcontrol
# For SPI1, /dev/spidev1.#
#
# sudo config-pin p9_17 spi_cs
# sudo config-pin p9_18 spi
# sudo config-pin p9_21 spi
# sudo config-pin p9_22 spi_sclk
 
# For SPI0, /dev/spidev2.#
#
sudo config-pin p9_28 spi_cs
sudo config-pin p9_29 spi
sudo config-pin p9_30 spi
sudo config-pin p9_31 spi_sclk

python3 ./pythonSPADspiControlBBBupON.py

# Gating signal control
sudo config-pin P8_19 pwm
if [[ "$answerGating" == "y" || "$answerGating" == "yes" ]]; then
    cd /sys/class/pwm/pwmchip7/pwm-7\:0
    sudo sh -c "echo '50' >> ./period"
    sudo sh -c "echo '5' >> ./duty_cycle"
    sudo sh -c "echo '1' >> ./enable"
    # Re-confirm order
    sudo sh -c "echo '1' >> ./enable"
    echo "Gating ON"
else
    cd /sys/class/pwm/pwmchip7/pwm-7\:0
    # Always at least set a period and duty cycle so that the pwm can be disabled
    sudo sh -c "echo '50' >> ./period"
    sudo sh -c "echo '5' >> ./duty_cycle"
    sudo sh -c "echo '0' >> ./enable"
    # Re-confirm order
    sudo sh -c "echo '0' >> ./enable"
    echo "Gating OFF"
fi
